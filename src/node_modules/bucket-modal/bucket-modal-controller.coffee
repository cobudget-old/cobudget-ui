_ = require('lodash')

### @ngInject ###
module.exports = ($scope, $modalInstance, BucketsStore, BucketModel, group, round, memberships, bucket) ->

  $scope.members = _.map memberships, (m) -> m.user

  if bucket
    serialBucket = bucket.serialize()
    $scope.id = serialBucket.id
    $scope.name = serialBucket.name
    $scope.description = serialBucket.description
    $scope.user = _.find $scope.members, (m) ->
      m.id == serialBucket.userId
    $scope.target = serialBucket.targetCents / 100

    $scope.title = "Edit Bucket!"
  else
    $scope.title = "New Bucket!"

  $scope.submit = (bucketForm) ->
    $scope.submitted = true

    if bucketForm.$invalid
      return

    unsavedBucket = new BucketModel({
      id: $scope.id
      name: $scope.name
      description: $scope.description
      user: $scope.user
      targetCents: $scope.target * 100
      roundId: round.id
    })

    # TODO error handling
    BucketsStore.save(unsavedBucket)
    .then (savedBucket) ->
      $modalInstance.close(savedBucket)

  $scope.cancel = ->
    $modalInstance.dismiss('cancel')
