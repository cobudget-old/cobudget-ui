_ = require('lodash')
Decimal = require('decimal')
debug = require('debug')('round-contributors:controller')

### @ngInject ###
module.exports = ($scope, $modal, $state, config, AuthService, AllocationModel, AllocationsStore, group, round, memberships) ->

  contributors = round.getContributors(memberships)
  allocations = round.getAllocationsByUser()

  $scope.round = round
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())

  $scope.contributors = _(contributors)
    .filter (contributor) ->
      # non-admins shouldn't see contributors with no allocations
      $scope.isAdmin or (!contributor.allocation.eq(0))
    .sortBy (contributor) ->
      contributor.user.name
    .value()

  $scope.updateAllocation = (contributor, data) ->
    allocation = allocations[contributor.user.id]

    if allocation
      allocation.amount = new Decimal(data)
    else
      allocation = new AllocationModel(
        userId: contributor.user.id
        amount: data
        roundId: round.id
      )
      allocations[contributor.user.id] = allocation
      round.allocations.add(allocation)

    AllocationsStore.save(allocation).then ->
      true
    , (err) ->
      # pass error to xeditable as string
      "Oh noes! :( We had a problem saving, please refresh and try again."

  # alerts
  $scope.alerts = []

  $scope.addAlert = (alert) ->
    $scope.alerts.push(alert)

  $scope.closeAlert = (index) ->
    $scope.alerts.splice(index, 1)
  # /alerts

  # csv upload handlers
  $scope.uploadPath = "#{config.apiEndpoint}/rounds/#{round.getId()}/allocations/upload"
  $scope.onUpload = (files) ->
  $scope.onSuccess = (response) ->
    debug("upload success", response)
    # TODO display success in alerts (see group-members)
    $state.reload('layout')
    # i want to add an alert after everything is reloaded, have no idea how
    # $scope.addAlert(
    #   type: "ya brah",
    #   msg: "everyone added brah"
    # )
  $scope.onError = (err) ->
    debug("upload error", err)
    $modal.open(
      require('error-modal')({ error: err })
    )
  $scope.onComplete = (response) ->
    debug("upload complete", response)





