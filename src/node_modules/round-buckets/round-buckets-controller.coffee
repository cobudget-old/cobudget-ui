_ = require('lodash')

### @ngInject ###
module.exports = ($scope, $modal, RoundsStore, ContributionsStore, AuthService, BucketsStore, group, round) ->

  $scope.round = round
  $scope.currentUserId = AuthService.getCurrentUser().id
  $scope.isAdmin = group.isAdmin(AuthService.getCurrentUser())

  $scope.saveContribution = (contribution) ->
    # if we're gonna have a bad time
    if round.balanceStatus == 'warning'
      # gtfo
      return
    # if no longer contributing a positive amount
    if not contribution.amount.gt(0)
      # delete contribution
      return ContributionsStore.remove(contribution)
    ContributionsStore.save(contribution)

  $scope.openNewBucketModal = ->
    $modal.open(
      require('bucket-modal')(
        round: round
        group: group
      )
    ).result.then (bucket) ->
      # TODO add new bucket in proper sort order
      round.buckets.splice(0, 0, bucket)
