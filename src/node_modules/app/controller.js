/* @ngInject */
module.exports = function ($scope, $urlRouter, $state, $modal, authModel, $http) {
  $scope.currentUser = authModel;

  $scope.updateCurrentUser = function () {
    $scope.updateCurrentUserHeaders();
  };

  $scope.updateCurrentUserHeaders = function () {
    var currentUser = $scope.currentUser;
    var defaultHeaders = {
      'Accept': 'application/json',
      'X-User-Token': currentUser.accessToken,
      'X-User-Email': currentUser.email,
    };
    $http.defaults.headers.common = defaultHeaders;
  };

  $scope.initializeUser = function () {
    $modal.open(
      require('init-person-modal')({
        person: $scope.currentUser,
      })
    ).result.then(function () {
      $urlRouter.sync();
    }, function (err) {
      // handle error
      if (err === 'backdrop click' && err === 'escape key press') {
        $scope.initializeUser();
      } else if (err) {
        $modal.open(
          require('error-modal')({ error: err })
        );
      }
    });
  };

  authModel.on('login-success', function () {
    $scope.updateCurrentUser();
    if ($scope.currentUser.initialized === false) {
      $scope.initializeUser();
    } else {
      $urlRouter.sync();
    }
  });

  authModel.on('logout-success', function () {
    $scope.updateCurrentUser();
  });

  $scope.updateCurrentUser();
};
